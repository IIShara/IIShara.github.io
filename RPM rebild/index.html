<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Ilgiz Sharafeev" /><link rel="canonical" href="https://IIShara.github.io/RPM%20rebild/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Пересборка RPM пакета NGINX - Личная документация</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u041f\u0435\u0440\u0435\u0441\u0431\u043e\u0440\u043a\u0430 RPM \u043f\u0430\u043a\u0435\u0442\u0430 NGINX";
        var mkdocs_page_input_path = "RPM rebild.md";
        var mkdocs_page_url = "/RPM%20rebild/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/shell.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Личная документация
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Главная</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Заметки</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../Markdown/">Синтаксис Markdown</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Git/">Основные команды Git</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Инструкции</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../Keycloak/">Keycloak</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Prometheus/">Prometheus</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Ansible/">Ansible</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Linux</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >Мониторинг</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../Top/">Top</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../vmstat/">Vmstat</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Сборка пакетов</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Пересборка RPM пакета NGINX</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#rpm_1">Процесс пересборки RPM пакетов</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rpm-">Сборка RPM-пакета с нуля</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rpm-nginx">Пересборка RPM пакета NGINX</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_1">Перед началом работ необходимо установить:</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#source-nginx">Скачать source пакет Nginx</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#openssl">Доюавление openssl последней версии</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#ngx_brotli">Добавление ngx_brotli</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#ngx_brotli_1">Сборка ngx_brotli</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#nginx">Установка зависимостей для сборки nginx</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nginx_1">Сборка nginx</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_2">Установка и проверка</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Личная документация</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Linux</li>
          <li class="breadcrumb-item">Сборка пакетов</li>
      <li class="breadcrumb-item active">Пересборка RPM пакета NGINX</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="rpm">Сборка RPM</h1>
<h2 id="rpm_1">Процесс пересборки RPM пакетов</h2>
<ul>
<li>Загрузим src.rpm файл с исходниками</li>
<li>Установим зависимости</li>
<li>Соберем пакет</li>
<li>Установим и проверим работу сервиса</li>
</ul>
<h2 id="rpm-">Сборка RPM-пакета с нуля</h2>
<ul>
<li>Создаем директорию для сборки</li>
<li>Получаем исходный код</li>
<li>Пишем spec-файл</li>
<li>Собираем пакет</li>
<li>Устанавливаем пакет</li>
</ul>
<hr />
<h2 id="rpm-nginx">Пересборка RPM пакета NGINX</h2>
<h3 id="_1">Перед началом работ необходимо установить:</h3>
<pre><code class="language-bash">yum install yum-utils wget tar git cmake gcc rpm-build perl
</code></pre>
<h3 id="source-nginx">Скачать source пакет Nginx</h3>
<p><strong>Скачать source пакет:</strong></p>
<pre><code class="language-bash">yumdownloader --source nginx
</code></pre>
<p>В результате получим:</p>
<pre><code># ll
total 1088
-rw-r--r--. 1 root root 1112203 Feb 20 07:33 nginx-1.20.1-20.el9.src.rpm

</code></pre>
<p><strong>Распаковка source rpm:</strong></p>
<pre><code class="language-bash">rpm -Uvh nginx*.src.rpm
</code></pre>
<p><code>-U</code> - upgrade package(s)</p>
<p><code>-v</code> - provide more detailed output</p>
<p><code>-h</code> - print hash marks as package installs (good with -v)</p>
<p>В результате получим:</p>
<pre><code># cd ~
# ll rpmbuild/
total 4
drwxr-xr-x. 2 root root 4096 Feb 20 07:36 SOURCES
drwxr-xr-x. 2 root root   24 Feb 20 07:36 SPECS
</code></pre>
<h3 id="openssl">Доюавление openssl последней версии</h3>
<p><strong>Скачать openssl последней версии, в этом случае openssl 3.4.1:</strong></p>
<pre><code>wget https://github.com/openssl/openssl/releases/download/openssl-3.4.1/openssl-3.4.1.tar.gz
</code></pre>
<p><strong>Распаковка openssl:</strong></p>
<pre><code>tar -xzvf openssl-3.4.1.tar.gz
</code></pre>
<p><code>-x</code> - extract files from an archive</p>
<p><code>-z</code> - filter the archive through gzip</p>
<p><code>-v</code> - verbosely list files processed</p>
<p><code>-f</code> - use archive file or device ARCHIVE</p>
<h3 id="ngx_brotli">Добавление ngx_brotli</h3>
<p><strong>Скачать ngx_brotli:</strong></p>
<pre><code>git clone --recurse-submodules -j8 https://github.com/google/ngx_brotli
</code></pre>
<p><code>--recurse-submodules</code> - After the clone is created, initialize and clone submodules within based
on the provided <pathspec>. If no =<pathspec> is provided, all
submodules are initialized and cloned. This option can be given multiple
times for pathspecs consisting of multiple entries. The resulting clone
has submodule.active set to the provided pathspec, or "." (meaning all
submodules) if no pathspec is provided.</p>
<p>Submodules are initialized and cloned using their default settings. This
is equivalent to running git submodule update --init --recursive
<pathspec> immediately after the clone is finished. This option is
ignored if the cloned repository does not have a worktree/checkout (i.e.
if any of --no-checkout/-n, --bare, or --mirror is given)</p>
<p><code>-j8</code> - The number of submodules fetched at the same time. Defaults to the submodule.fetchJobs option</p>
<h3 id="ngx_brotli_1">Сборка ngx_brotli</h3>
<p>Команды взяты из <a href="https://github.com/google/ngx_brotli?tab=readme-ov-file#installation">GitHub</a></p>
<pre><code class="language-bash">git clone --recurse-submodules -j8 https://github.com/google/ngx_brotli
cd ngx_brotli/deps/brotli
mkdir out &amp;&amp; cd out
cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS=&quot;-Ofast -m64 -march=native -mtune=native -flto -funroll-loops -ffunction-sections -fdata-sections -Wl,--gc-sections&quot; -DCMAKE_CXX_FLAGS=&quot;-Ofast -m64 -march=native -mtune=native -flto -funroll-loops -ffunction-sections -fdata-sections -Wl,--gc-sections&quot; -DCMAKE_INSTALL_PREFIX=./installed ..
cmake --build . --config Release --target brotlienc
cd ../../../.
</code></pre>
<h3 id="nginx">Установка зависимостей для сборки nginx</h3>
<pre><code class="language-bash">yum-builddep nginx
</code></pre>
<h2 id="nginx_1">Сборка nginx</h2>
<p><strong>Редактируем <code>./rpmbuild/SPECS/nginx.spec</code></strong></p>
<pre><code class="language-bash">vi ./rpmbuild/SPECS/nginx.spec
</code></pre>
<p><strong>В секцию ./configure добавляем следующее:</strong></p>
<p><code>--add-module=/root/ngx_brotli \</code> - указываем путь до ngx_brotli</p>
<p><code>--with-openssl=/root/openssl-3.4.1 \</code> - Указываем путь до openssl</p>
<p><code>--with-openssl-opt='-fno-lto' \</code> - отключаем предупреждения openssl</p>
<pre><code class="language-bash">if ! ./configure \
    --prefix=%{_datadir}/nginx \
    --sbin-path=%{_sbindir}/nginx \
    --modules-path=%{nginx_moduledir} \
    --conf-path=%{_sysconfdir}/nginx/nginx.conf \
    --error-log-path=%{_localstatedir}/log/nginx/error.log \
    --http-log-path=%{_localstatedir}/log/nginx/access.log \
    --http-client-body-temp-path=%{_localstatedir}/lib/nginx/tmp/client_body \
    --http-proxy-temp-path=%{_localstatedir}/lib/nginx/tmp/proxy \
    --http-fastcgi-temp-path=%{_localstatedir}/lib/nginx/tmp/fastcgi \
    --http-uwsgi-temp-path=%{_localstatedir}/lib/nginx/tmp/uwsgi \
    --http-scgi-temp-path=%{_localstatedir}/lib/nginx/tmp/scgi \
    --pid-path=/run/nginx.pid \
    --lock-path=/run/lock/subsys/nginx \
    --user=%{nginx_user} \
    --group=%{nginx_user} \
    --with-compat \
    --add-module=/root/ngx_brotli \
    --with-openssl=/root/openssl-3.4.1 \
    --with-openssl-opt='-fno-lto' \
    --with-debug \
</code></pre>
<p><strong>Собираем rpm пакет:</strong></p>
<pre><code>cd ./rpmbuild/SPECS/
rpmbuild -ba nginx.spec -D 'debug_package %{nil}'
</code></pre>
<p>Результат:</p>
<pre><code class="language-bash">[root@localhost rpmbuild]# ll
total 4
drwxr-xr-x. 3 root root   43 Feb 20 08:46 BUILD
drwxr-xr-x. 2 root root    6 Feb 20 08:54 BUILDROOT
drwxr-xr-x. 4 root root   34 Feb 20 08:54 RPMS
drwxr-xr-x. 2 root root 4096 Feb 20 07:36 SOURCES
drwxr-xr-x. 2 root root   24 Feb 20 08:37 SPECS
drwxr-xr-x. 2 root root   41 Feb 20 08:53 SRPMS

</code></pre>
<pre><code># ll RPMS/
total 4
drwxr-xr-x. 2 root root  105 Feb 20 08:54 noarch
drwxr-xr-x. 2 root root 4096 Feb 20 08:54 x86_64
</code></pre>
<pre><code>[root@localhost rpmbuild]# cp ~/rpmbuild/RPMS/noarch/* ~/rpmbuild/RPMS/x86_64/
[root@localhost rpmbuild]# cd RPMS/x86_64/
[root@localhost x86_64]# ll
total 4136
-rw-r--r--. 1 root root   36141 Feb 20 08:54 nginx-1.20.1-20.el9.x86_64.rpm
-rw-r--r--. 1 root root    7209 Feb 20 22:57 nginx-all-modules-1.20.1-20.el9.noarch.rpm
-rw-r--r--. 1 root root 3200520 Feb 20 08:54 nginx-core-1.20.1-20.el9.x86_64.rpm
-rw-r--r--. 1 root root    8324 Feb 20 22:57 nginx-filesystem-1.20.1-20.el9.noarch.rpm
-rw-r--r--. 1 root root  759182 Feb 20 08:54 nginx-mod-devel-1.20.1-20.el9.x86_64.rpm
-rw-r--r--. 1 root root   19233 Feb 20 08:54 nginx-mod-http-image-filter-1.20.1-20.el9.x86_64.rpm
-rw-r--r--. 1 root root   30891 Feb 20 08:54 nginx-mod-http-perl-1.20.1-20.el9.x86_64.rpm
-rw-r--r--. 1 root root   18043 Feb 20 08:54 nginx-mod-http-xslt-filter-1.20.1-20.el9.x86_64.rpm
-rw-r--r--. 1 root root   53641 Feb 20 08:54 nginx-mod-mail-1.20.1-20.el9.x86_64.rpm
-rw-r--r--. 1 root root   80195 Feb 20 08:54 nginx-mod-stream-1.20.1-20.el9.x86_64.rpm
</code></pre>
<h2 id="_2">Установка и проверка</h2>
<pre><code>yum localinstall *.rpm
</code></pre>
<pre><code class="language-bash"># nginx -V
nginx version: nginx/1.20.1
built by gcc 11.5.0 20240719 (Red Hat 11.5.0-5) (GCC)
built with OpenSSL 3.4.1 11 Feb 2025 #Версия OpenSSL, которую мы добавили
TLS SNI support enabled
configure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-p                                                                                                                        ath=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/l                                                                                                                        og/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-p                                                                                                                        ath=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --h                                                                                                                        ttp-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx                                                                                                                        /tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --l                                                                                                                        ock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --add-module=                                                                                                                        /root/ngx_brotli --with-openssl=/root/openssl-3.4.1 --with-openssl-opt=-fno-lto --with                                                                                                                        -debug --with-file-aio --with-http_addition_module --with-http_auth_request_module --w                                                                                                                        ith-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_                                                                                                                        gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic -                                                                                                                        -with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module                                                                                                                         --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --wi                                                                                                                        th-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v                                                                                                                        2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --                                                                                                                        with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream                                                                                                                        _ssl_preread_module --with-threads --with-cc-opt='-O2 -flto=auto -ffat-lto-objects -fe                                                                                                                        xceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_                                                                                                                        SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -fst                                                                                                                        ack-protector-strong -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -march=x86-64-                                                                                                                        v2 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protectio                                                                                                                        n' --with-ld-opt='-Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/r                                                                                                                        edhat-hardened-ld -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -Wl,-E'

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../vmstat/" class="btn btn-neutral float-left" title="Vmstat"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../vmstat/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
